<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGX Minerals Transport Billing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .bill-container {
            display: none;
            margin-top: 30px;
            background-color: #fff;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .table {
            font-size: 14px;
        }
        .table thead th {
            background-color: #343a40;
            color: white;
        }
        .form-control:read-only {
            background-color: #f8f9fa;
        }
        #netWeight, #totalPrice {
            font-weight: bold;
        }
        .custom-dropdown {
            position: relative;
        }
        .add-new-option {
            color: #0d6efd;
            cursor: pointer;
            padding: 8px 12px;
        }
        .add-new-option:hover {
            background-color: #f8f9fa;
        }
        .dropdown-input-container {
            padding: 8px 12px;
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .bill-container, .bill-container * {
                visibility: visible;
            }
            .bill-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
            .table {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>Transport Billing System</h1>
            <p class="lead">SGX Minerals Pvt Ltd</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3>Add New Transaction</h3>
                <form id="transactionForm">
                    <div class="mb-3 custom-dropdown">
                        <label for="client" class="form-label">Client</label>
                        <select class="form-select" id="client" required>
                            <option value="">Select Client</option>
                            <option value="L & T P1 – Rambali">L & T P1 – Rambali</option>
                            <option value="L & T P2 – Rambali">L & T P2 – Rambali</option>
                            <option value="KEC – Rambali">KEC – Rambali</option>
                            <option value="JS Mining – Rambali">JS Mining – Rambali</option>
                            <option value="ITD – Rambali">ITD – Rambali</option>
                            <option value="Sowaparnika – Rambali">Sowaparnika – Rambali</option>
                            <option value="L & T Jio – Sindhiya">L & T Jio – Sindhiya</option>
                            <option value="Arabind – Shela Nagar">Arabind – Shela Nagar</option>
                            <option value="RKD – Shela Nagar">RKD – Shela Nagar</option>
                            <option value="Afcyan – Shela Ngr">Afcyan – Shela Ngr</option>
                            <option value="Bharath Verma – Airport">Bharath Verma – Airport</option>
                            <option value="Aparna RMC – Gajuwaka">Aparna RMC – Gajuwaka</option>
                            <option value="ACC RMC – Gajuwaka">ACC RMC – Gajuwaka</option>
                            <option value="Prisam RMC – Gajuwaka">Prisam RMC – Gajuwaka</option>
                            <option value="Nuvoco RMC – Gajuwaka">Nuvoco RMC – Gajuwaka</option>
                            <option value="Ultratech – Mindi">Ultratech – Mindi</option>
                            <option value="MK Builders – Madhurwada">MK Builders – Madhurwada</option>
                            <option value="North Star Homes – Madhurwada">North Star Homes – Madhurwada</option>
                            <option value="Coastal RMC – Madhurwada">Coastal RMC – Madhurwada</option>
                            <option value="Coastal RMC – Achututapuram">Coastal RMC – Achututapuram</option>
                            <option value="Vizag Port – Vizag Port">Vizag Port – Vizag Port</option>
                        </select>
                        <div class="add-new-option" onclick="showAddOptionInput('client')">+ Add New Client</div>
                        <div class="dropdown-input-container" id="clientInputContainer">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newClientInput" placeholder="New client name">
                                <button class="btn btn-outline-secondary" type="button" onclick="addNewOption('client')">Add</button>
                            </div>
                            <small class="text-muted">Format: Name – Location</small>
                        </div>
                    </div>
                    <div class="mb-3 custom-dropdown">
                        <label for="product" class="form-label">Product</label>
                        <select class="form-select" id="product" required>
                            <option value="">Select Product</option>
                            <option value="10mm">10mm</option>
                            <option value="20mm">20mm</option>
                            <option value="40mm">40mm</option>
                            <option value="Rivo sand">Rivo sand</option>
                            <option value="Scolpin">Scolpin</option>
                            <option value="GSB">GSB</option>
                            <option value="P/Sand">P/Sand</option>
                        </select>
                        <div class="add-new-option" onclick="showAddOptionInput('product')">+ Add New Product</div>
                        <div class="dropdown-input-container" id="productInputContainer">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newProductInput" placeholder="New product name">
                                <button class="btn btn-outline-secondary" type="button" onclick="addNewOption('product')">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="grossWeight" class="form-label">Gross Weight (tons)</label>
                            <input type="number" step="0.01" class="form-control" id="grossWeight" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="tareWeight" class="form-label">Tare Weight (tons)</label>
                            <input type="number" step="0.01" class="form-control" id="tareWeight" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="netWeight" class="form-label">Net Weight (tons)</label>
                            <input type="number" step="0.01" class="form-control" id="netWeight" readonly>
                        </div>
                    </div>
                    <div class="mb-3 custom-dropdown">
                        <label for="transportName" class="form-label">Transport Name</label>
                        <select class="form-select" id="transportName" required>
                            <option value="">Select Transport Name</option>
                            <option value="Sri Venkateswara Transports">Sri Venkateswara Transports</option>
                            <option value="Sai Transports">Sai Transports</option>
                            <option value="Ganesh Transports">Ganesh Transports</option>
                            <option value="Lakshmi Transports">Lakshmi Transports</option>
                            <option value="Balaji Transports">Balaji Transports</option>
                            <option value="Shiva Transports">Shiva Transports</option>
                            <option value="Ram Transports">Ram Transports</option>
                            <option value="Krishna Transports">Krishna Transports</option>
                            <option value="Hanuman Transports">Hanuman Transports</option>
                            <option value="Surya Transports">Surya Transports</option>
                        </select>
                        <div class="add-new-option" onclick="showAddOptionInput('transportName')">+ Add New Transport</div>
                        <div class="dropdown-input-container" id="transportNameInputContainer">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newTransportNameInput" placeholder="New transport name">
                                <button class="btn btn-outline-secondary" type="button" onclick="addNewOption('transportName')">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3 custom-dropdown">
                        <label for="transporterName" class="form-label">Transporter Name</label>
                        <select class="form-select" id="transporterName" required>
                            <option value="">Select Transporter Name</option>
                            <option value="Raju">Raju</option>
                            <option value="Mohan">Mohan</option>
                            <option value="Suresh">Suresh</option>
                            <option value="Ramesh">Ramesh</option>
                            <option value="Shiva">Shiva</option>
                            <option value="Venkat">Venkat</option>
                            <option value="Nagesh">Nagesh</option>
                            <option value="Chandra">Chandra</option>
                            <option value="Arun">Arun</option>
                            <option value="Prakash">Prakash</option>
                        </select>
                        <div class="add-new-option" onclick="showAddOptionInput('transporterName')">+ Add New Transporter</div>
                        <div class="dropdown-input-container" id="transporterNameInputContainer">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newTransporterNameInput" placeholder="New transporter name">
                                <button class="btn btn-outline-secondary" type="button" onclick="addNewOption('transporterName')">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="truckNumber" class="form-label">Truck Number</label>
                        <input type="text" class="form-control" id="truckNumber" required>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Price (per ton)</label>
                        <input type="number" step="0.01" class="form-control" id="price" required>
                    </div>
                    <div class="mb-3">
                        <label for="totalPrice" class="form-label">Total Price</label>
                        <input type="number" step="0.01" class="form-control" id="totalPrice" readonly>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                </form>
            </div>

            <div class="col-md-6">
                <h3>Generate Monthly Bill</h3>
                <form id="billForm">
                    <div class="mb-3">
                        <label for="billType" class="form-label">Bill Type</label>
                        <select class="form-select" id="billType" required>
                            <option value="client">Client Bill</option>
                            <option value="transporter">Transporter Bill</option>
                        </select>
                    </div>
                    <div class="mb-3" id="clientBillSection">
                        <label for="billClient" class="form-label">Select Client</label>
                        <select class="form-select" id="billClient">
                            <option value="">Select Client</option>
                            <option value="L & T P1 – Rambali">L & T P1 – Rambali</option>
                            <option value="L & T P2 – Rambali">L & T P2 – Rambali</option>
                            <option value="KEC – Rambali">KEC – Rambali</option>
                            <option value="JS Mining – Rambali">JS Mining – Rambali</option>
                            <option value="ITD – Rambali">ITD – Rambali</option>
                            <option value="Sowaparnika – Rambali">Sowaparnika – Rambali</option>
                            <option value="L & T Jio – Sindhiya">L & T Jio – Sindhiya</option>
                            <option value="Arabind – Shela Nagar">Arabind – Shela Nagar</option>
                            <option value="RKD – Shela Nagar">RKD – Shela Nagar</option>
                            <option value="Afcyan – Shela Ngr">Afcyan – Shela Ngr</option>
                            <option value="Bharath Verma – Airport">Bharath Verma – Airport</option>
                            <option value="Aparna RMC – Gajuwaka">Aparna RMC – Gajuwaka</option>
                            <option value="ACC RMC – Gajuwaka">ACC RMC – Gajuwaka</option>
                            <option value="Prisam RMC – Gajuwaka">Prisam RMC – Gajuwaka</option>
                            <option value="Nuvoco RMC – Gajuwaka">Nuvoco RMC – Gajuwaka</option>
                            <option value="Ultratech – Mindi">Ultratech – Mindi</option>
                            <option value="MK Builders – Madhurwada">MK Builders – Madhurwada</option>
                            <option value="North Star Homes – Madhurwada">North Star Homes – Madhurwada</option>
                            <option value="Coastal RMC – Madhurwada">Coastal RMC – Madhurwada</option>
                            <option value="Coastal RMC – Achututapuram">Coastal RMC – Achututapuram</option>
                            <option value="Vizag Port – Vizag Port">Vizag Port – Vizag Port</option>
                        </select>
                    </div>
                    <div class="mb-3" id="transporterBillSection" style="display: none;">
                        <label for="billTransporter" class="form-label">Select Transporter</label>
                        <select class="form-select" id="billTransporter">
                            <option value="">Select Transporter</option>
                            <option value="Raju">Raju</option>
                            <option value="Mohan">Mohan</option>
                            <option value="Suresh">Suresh</option>
                            <option value="Ramesh">Ramesh</option>
                            <option value="Shiva">Shiva</option>
                            <option value="Venkat">Venkat</option>
                            <option value="Nagesh">Nagesh</option>
                            <option value="Chandra">Chandra</option>
                            <option value="Arun">Arun</option>
                            <option value="Prakash">Prakash</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="month" class="form-label">Select Month</label>
                        <input type="month" class="form-control" id="month" required>
                    </div>
                    <button type="submit" class="btn btn-success">Generate Bill</button>
                    <button type="button" id="saveBillBtn" class="btn btn-info">Save Bill</button>
                </form>

                <div id="billContainer" class="bill-container">
                    <div class="text-center mb-4">
                        <h4>SGX Minerals Pvt Ltd</h4>
                        <p>Transport Bill</p>
                    </div>
                    <div id="billDetails" class="mb-4">
                        <div id="clientDetails"></div>
                        <div id="billPeriod"></div>
                        <div id="transportInfo"></div>
                    </div>
                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Product</th>
                                <th>Gross Wt.</th>
                                <th>Tare Wt.</th>
                                <th>Net Wt.</th>
                                <th>Price/Ton</th>
                                <th>Amount</th>
                                <th>Transport</th>
                                <th>Truck No.</th>
                            </tr>
                        </thead>
                        <tbody id="billTransactions">
                            <!-- Transactions will be added here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="7" class="text-end">Total Amount:</th>
                                <th colspan="3" id="totalAmount">0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="mt-4">
                        <p>For SGX Minerals Pvt Ltd</p>
                        <p class="mt-4">_________________________</p>
                        <p>Authorized Signatory</p>
                    </div>
                    <div class="text-center mt-4 no-print">
                        <button id="printBill" class="btn btn-primary me-2">Print Bill</button>
                        <button id="downloadBill" class="btn btn-secondary">Download as PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <h3>All Transactions</h3>
                <div class="table-responsive">
                    <table class="table table-striped" id="allTransactions">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Product</th>
                                <th>Gross Wt.</th>
                                <th>Tare Wt.</th>
                                <th>Net Wt.</th>
                                <th>Transport</th>
                                <th>Transporter</th>
                                <th>Truck No.</th>
                                <th>Price/Ton</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- All transactions will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Database setup using localStorage
        let transactions = JSON.parse(localStorage.getItem('sgx-transactions')) || [];
        let bills = JSON.parse(localStorage.getItem('sgx-bills')) || [];
        let customOptions = JSON.parse(localStorage.getItem('sgx-custom-options')) || {
            client: [],
            product: [],
            transportName: [],
            transporterName: []
        };

        // Price per ton based on location
        const locationPrices = {
            'Rambali': 260,
            'Gajuwaka': 170,
            'Madhurwada': 260,
            'Sindhiya': 190,
            'Shela Nagar': 210,
            'Shela Ngr': 230,
            'Airport': 210,
            'Mindi': 180,
            'Achututapuram': 170,
            'Vizag Port': 260
        };

        // DOM elements
        const transactionForm = document.getElementById('transactionForm');
        const billForm = document.getElementById('billForm');
        const allTransactionsTable = document.getElementById('allTransactions').getElementsByTagName('tbody')[0];
        const billContainer = document.getElementById('billContainer');
        const billTransactions = document.getElementById('billTransactions');
        const totalAmountElement = document.getElementById('totalAmount');
        const printBillBtn = document.getElementById('printBill');
        const downloadBillBtn = document.getElementById('downloadBill');
        const saveBillBtn = document.getElementById('saveBillBtn');
        const clientDetails = document.getElementById('clientDetails');
        const billPeriod = document.getElementById('billPeriod');
        const transportInfo = document.getElementById('transportInfo');
        const grossWeightInput = document.getElementById('grossWeight');
        const tareWeightInput = document.getElementById('tareWeight');
        const netWeightInput = document.getElementById('netWeight');
        const priceInput = document.getElementById('price');
        const totalPriceInput = document.getElementById('totalPrice');
        const clientSelect = document.getElementById('client');
        const billTypeSelect = document.getElementById('billType');
        const clientBillSection = document.getElementById('clientBillSection');
        const transporterBillSection = document.getElementById('transporterBillSection');

        // Toggle between client and transporter bill sections
        billTypeSelect.addEventListener('change', function() {
            if (this.value === 'client') {
                clientBillSection.style.display = 'block';
                transporterBillSection.style.display = 'none';
                document.getElementById('billTransporter').required = false;
                document.getElementById('billClient').required = true;
            } else {
                clientBillSection.style.display = 'none';
                transporterBillSection.style.display = 'block';
                document.getElementById('billClient').required = false;
                document.getElementById('billTransporter').required = true;
            }
        });

        // Calculate net weight and total price automatically
        grossWeightInput.addEventListener('input', calculateWeights);
        tareWeightInput.addEventListener('input', calculateWeights);
        priceInput.addEventListener('input', calculateTotalPrice);

        // Set price based on selected client location
        clientSelect.addEventListener('change', function() {
            const selectedClient = this.value;
            if (selectedClient) {
                const location = selectedClient.split('–')[1].trim();
                if (locationPrices[location]) {
                    priceInput.value = locationPrices[location];
                    calculateTotalPrice();
                }
            }
        });

        function calculateWeights() {
            const grossWeight = parseFloat(grossWeightInput.value) || 0;
            const tareWeight = parseFloat(tareWeightInput.value) || 0;
            
            // Validate that gross weight is greater than tare weight
            if (tareWeight > 0 && grossWeight <= tareWeight) {
                alert('Gross weight must be greater than tare weight');
                tareWeightInput.value = '';
                netWeightInput.value = '';
                totalPriceInput.value = '';
                return;
            }
            
            const netWeight = grossWeight - tareWeight;
            netWeightInput.value = netWeight.toFixed(2);
            calculateTotalPrice();
        }

        function calculateTotalPrice() {
            const netWeight = parseFloat(netWeightInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const totalPrice = netWeight * price;
            totalPriceInput.value = totalPrice.toFixed(2);
        }

        // Show input field to add new option
        function showAddOptionInput(fieldType) {
            // Hide all input containers first
            document.querySelectorAll('.dropdown-input-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Show the selected input container
            document.getElementById(`${fieldType}InputContainer`).style.display = 'block';
        }

        // Add new option to dropdown
        function addNewOption(fieldType) {
            const inputField = document.getElementById(`new${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}Input`);
            const newValue = inputField.value.trim();
            
            if (!newValue) {
                alert('Please enter a value');
                return;
            }
            
            // Add to custom options
            if (!customOptions[fieldType].includes(newValue)) {
                customOptions[fieldType].push(newValue);
                localStorage.setItem('sgx-custom-options', JSON.stringify(customOptions));
            }
            
            // Add to dropdown
            const selectElement = document.getElementById(fieldType);
            const option = document.createElement('option');
            option.value = newValue;
            option.textContent = newValue;
            selectElement.appendChild(option);
            
            // Select the new option
            selectElement.value = newValue;
            
            // Hide input container and clear input
            document.getElementById(`${fieldType}InputContainer`).style.display = 'none';
            inputField.value = '';
            
            // If it's a client field, try to set price based on location
            if (fieldType === 'client') {
                const location = newValue.split('–')[1];
                if (location && locationPrices[location.trim()]) {
                    priceInput.value = locationPrices[location.trim()];
                    calculateTotalPrice();
                }
            }
        }

        // Load custom options into dropdowns
        function loadCustomOptions() {
            for (const fieldType in customOptions) {
                const selectElement = document.getElementById(fieldType);
                customOptions[fieldType].forEach(value => {
                    if (!selectElement.querySelector(`option[value="${value}"]`)) {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        selectElement.appendChild(option);
                    }
                });
            }
        }

        // Form submit - Add new transaction
        transactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate weights again
            const grossWeight = parseFloat(grossWeightInput.value);
            const tareWeight = parseFloat(tareWeightInput.value);
            
            if (grossWeight <= tareWeight) {
                alert('Gross weight must be greater than tare weight');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                client: document.getElementById('client').value,
                product: document.getElementById('product').value,
                grossWeight: grossWeight,
                tareWeight: tareWeight,
                netWeight: parseFloat(netWeightInput.value),
                transportName: document.getElementById('transportName').value,
                transporterName: document.getElementById('transporterName').value,
                truckNumber: document.getElementById('truckNumber').value,
                date: document.getElementById('date').value,
                price: parseFloat(priceInput.value),
                totalPrice: parseFloat(totalPriceInput.value)
            };
            
            transactions.push(transaction);
            saveTransactions();
            renderAllTransactions();
            transactionForm.reset();
            
            // Reset price if it was auto-set
            if (clientSelect.value) {
                const location = clientSelect.value.split('–')[1].trim();
                if (locationPrices[location]) {
                    priceInput.value = locationPrices[location];
                }
            }
            
            alert('Transaction saved successfully!');
        });

        // Form submit - Generate bill
        billForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const billType = document.getElementById('billType').value;
            const month = document.getElementById('month').value;
            
            if (billType === 'client') {
                const client = document.getElementById('billClient').value;
                if (!client) {
                    alert('Please select a client');
                    return;
                }
                generateBill('client', client, month);
            } else {
                const transporter = document.getElementById('billTransporter').value;
                if (!transporter) {
                    alert('Please select a transporter');
                    return;
                }
                generateBill('transporter', transporter, month);
            }
        });

        // Save bill button
        saveBillBtn.addEventListener('click', function() {
            if (!billContainer.style.display || billContainer.style.display === 'none') {
                alert('Please generate a bill first');
                return;
            }
            
            const billType = document.getElementById('billType').value;
            const month = document.getElementById('month').value;
            const billFor = billType === 'client' 
                ? document.getElementById('billClient').value 
                : document.getElementById('billTransporter').value;
            
            // Get the transactions shown in the bill
            const billTransactionsData = [];
            const rows = billTransactions.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                billTransactionsData.push({
                    date: cells[0].textContent,
                    client: cells[1].textContent,
                    product: cells[2].textContent,
                    grossWeight: parseFloat(cells[3].textContent),
                    tareWeight: parseFloat(cells[4].textContent),
                    netWeight: parseFloat(cells[5].textContent),
                    price: parseFloat(cells[6].textContent.replace('₹', '')),
                    amount: parseFloat(cells[7].textContent.replace('₹', '')),
                    transportName: cells[8].textContent,
                    truckNumber: cells[9].textContent
                });
            }
            
            const bill = {
                id: Date.now(),
                billType,
                billFor,
                month,
                transactions: billTransactionsData,
                totalAmount: parseFloat(totalAmountElement.textContent),
                createdAt: new Date().toISOString()
            };
            
            bills.push(bill);
            localStorage.setItem('sgx-bills', JSON.stringify(bills));
            alert('Bill saved successfully!');
        });

        // Print bill button
        printBillBtn.addEventListener('click', function() {
            window.print();
        });

        // Download as PDF button
        downloadBillBtn.addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Add company header
            doc.setFontSize(16);
            doc.setTextColor(40);
            doc.text('SGX Minerals Pvt Ltd', doc.internal.pageSize.width / 2, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Transport Bill', doc.internal.pageSize.width / 2, 22, { align: 'center' });
            
            // Add bill details
            doc.setFontSize(12);
            const clientDetailsText = clientDetails.innerHTML.split('<br>');
            clientDetailsText.forEach((line, index) => {
                if (line.trim() !== '') {
                    doc.text(line.replace(/<[^>]*>/g, ''), 20, 40 + (index * 7));
                }
            });
            
            // Add bill period
            const billPeriodText = billPeriod.innerHTML.split('<br>');
            billPeriodText.forEach((line, index) => {
                if (line.trim() !== '') {
                    doc.text(line.replace(/<[^>]*>/g, ''), 20, 60 + (index * 7));
                }
            });
            
            // Add transport info if filtered
            const transportInfoText = transportInfo.innerHTML.split('<br>');
            if (transportInfoText[0].trim() !== '') {
                transportInfoText.forEach((line, index) => {
                    if (line.trim() !== '') {
                        doc.text(line.replace(/<[^>]*>/g, ''), 20, 80 + (index * 7));
                    }
                });
            }
            
            // Add table headers
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            const headers = ["Date", "Client", "Product", "Gross", "Tare", "Net", "Price", "Amount", "Transport", "Truck No"];
            let x = 15;
            const columnWidths = [20, 30, 20, 15, 15, 15, 15, 20, 25, 25];
            headers.forEach((header, index) => {
                doc.text(header, x, 100);
                x += columnWidths[index];
            });
            
            // Add transactions
            doc.setFont(undefined, 'normal');
            const rows = billTransactions.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                x = 15;
                for (let j = 0; j < cells.length; j++) {
                    doc.text(cells[j].textContent, x, 110 + (i * 10));
                    x += columnWidths[j];
                }
            }
            
            // Add total
            doc.setFont(undefined, 'bold');
            doc.text(`Total Amount: ₹${totalAmountElement.textContent}`, doc.internal.pageSize.width - 20, 110 + (rows.length * 10), { align: 'right' });
            
            // Add footer
            doc.setFontSize(10);
            doc.text('For SGX Minerals Pvt Ltd', 20, 130 + (rows.length * 10));
            doc.text('Authorized Signatory', doc.internal.pageSize.width - 20, 150 + (rows.length * 10), { align: 'right' });
            doc.line(doc.internal.pageSize.width - 50, 152 + (rows.length * 10), doc.internal.pageSize.width - 20, 152 + (rows.length * 10));
            
            // Save the PDF
            const billType = document.getElementById('billType').value;
            const billFor = billType === 'client' 
                ? document.getElementById('billClient').value 
                : document.getElementById('billTransporter').value;
            const month = document.getElementById('month').value;
            
            let filename = '';
            if (billType === 'client') {
                filename = `SGX_Client_Bill_${billFor.split('–')[0].trim()}_${month}`;
            } else {
                filename = `SGX_Transporter_Bill_${billFor}_${month}`;
            }
            
            doc.save(`${filename}.pdf`);
        });

        // Save transactions to localStorage
        function saveTransactions() {
            localStorage.setItem('sgx-transactions', JSON.stringify(transactions));
        }

        // Render all transactions in the table
        function renderAllTransactions() {
            allTransactionsTable.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = allTransactionsTable.insertRow();
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.client}</td>
                    <td>${transaction.product}</td>
                    <td>${transaction.grossWeight.toFixed(2)}</td>
                    <td>${transaction.tareWeight.toFixed(2)}</td>
                    <td>${transaction.netWeight.toFixed(2)}</td>
                    <td>${transaction.transportName}</td>
                    <td>${transaction.transporterName}</td>
                    <td>${transaction.truckNumber}</td>
                    <td>₹${transaction.price.toFixed(2)}</td>
                    <td>₹${transaction.totalPrice.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${transaction.id})">Delete</button>
                    </td>
                `;
            });
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(transaction => transaction.id !== id);
                saveTransactions();
                renderAllTransactions();
                
                // Hide bill container if it's showing the deleted transaction
                billContainer.style.display = 'none';
            }
        }

        // Generate bill for a client or transporter for a specific month
        function generateBill(billType, billFor, month) {
            const [year, monthNum] = month.split('-');
            let filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return (billType === 'client' ? transaction.client === billFor : transaction.transporterName === billFor) &&
                       transactionDate.getFullYear() == year && 
                       (transactionDate.getMonth() + 1) == monthNum;
            });
            
            if (filteredTransactions.length === 0) {
                alert(`No transactions found for ${billType === 'client' ? 'this client' : 'this transporter'} in the selected month.`);
                return;
            }
            
            // Display bill container
            billContainer.style.display = 'block';
            
            // Set bill details
            const monthNames = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
            
            if (billType === 'client') {
                clientDetails.innerHTML = `
                    <strong>Client:</strong> ${billFor.split('–')[0].trim()}<br>
                    <strong>Location:</strong> ${billFor.split('–')[1].trim()}
                `;
            } else {
                clientDetails.innerHTML = `
                    <strong>Transporter:</strong> ${billFor}
                `;
            }
            
            billPeriod.innerHTML = `
                <strong>Bill Period:</strong> ${monthNames[parseInt(monthNum) - 1]} ${year}<br>
                <strong>Bill Date:</strong> ${new Date().toLocaleDateString()}
            `;
            
            // Add transactions to bill
            billTransactions.innerHTML = '';
            let totalAmount = 0;
            
            filteredTransactions.forEach(transaction => {
                const row = billTransactions.insertRow();
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.client}</td>
                    <td>${transaction.product}</td>
                    <td>${transaction.grossWeight.toFixed(2)}</td>
                    <td>${transaction.tareWeight.toFixed(2)}</td>
                    <td>${transaction.netWeight.toFixed(2)}</td>
                    <td>₹${transaction.price.toFixed(2)}</td>
                    <td>₹${transaction.totalPrice.toFixed(2)}</td>
                    <td>${transaction.transportName}</td>
                    <td>${transaction.truckNumber}</td>
                `;
                
                totalAmount += transaction.totalPrice;
            });
            
            // Update total amount
            totalAmountElement.textContent = totalAmount.toFixed(2);
        }

        // Initialize the app
        function init() {
            loadCustomOptions();
            renderAllTransactions();
            
            // Set default date to today
            document.getElementById('date').valueAsDate = new Date();
        }

        // Make functions available globally
        window.deleteTransaction = deleteTransaction;
        window.showAddOptionInput = showAddOptionInput;
        window.addNewOption = addNewOption;

        init();
    </script>
</body>
</html>
